version: 2.1

setup: true

orbs:
  continuation: circleci/continuation@1

jobs:
  setup:
    executor: continuation/default
    steps:
      - checkout
      - run:
          name: Install Nix
          command: |
            cat \<< 'EOF' > /tmp/nix.conf
              allowed-users = *
              builders = 
              builders-use-substitutes = true
              cores = 0
              experimental-features = nix-command flakes ca-derivations
              keep-derivations = true
              keep-outputs = true
              max-jobs = auto
              require-sigs = true
              sandbox = false
              sandbox-fallback = true
              substituters = https://cache.nixos.org/
              system-features = nixos-test benchmark big-parallel kvm
              trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY=
              trusted-substituters = 
              trusted-users = root circleci
            EOF
            sh <(curl -L https://nixos.org/nix/install) --no-daemon
            sudo mkdir -p /etc/nix/
            sudo mv /tmp/nix.conf /etc/nix/
            echo 'export USER=circleci' >> $BASH_ENV
            echo '. /home/circleci/.nix-profile/etc/profile.d/nix.sh' >> $BASH_ENV
      - run:
          name: Evaluate Nix expressions and build dependency graph
          command: |
            nix build .#config
            mkdir -p nars
            nix-store --export $(nix-store -qR result) > nars/eval.nar
            cp result /tmp/config
            CHECKSUM=$(sha256sum result | xxd -r -p | base64 | tr '/' '_')
            jq -n --arg cs "$CHECKSUM" '{"eval-cache-key": ("nix-store-eval-" + $cs)}' > /tmp/params.json
      - save_cache:
          key: nix-store-eval-{{ checksum "/tmp/config" }}
          paths: ["nars"]
      - continuation/continue:
          configuration_path: result
          parameters: /tmp/params.json

workflows:
  setup-dynamic-config:
    jobs:
      - setup
